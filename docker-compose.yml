version: "3"

services:
  dashboard:
    image: atb00ker/ready-to-run:openwisp-dashboard
    build: 
      context: build
      dockerfile: openwisp_dashboard/Dockerfile
    deploy:
      replicas: 1
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      - DB_ENGINE=${DB_GIS_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DJANGO_LANGUAGE_CODE=${DJANGO_LANGUAGE_CODE}
      - DJANGO_TIME_ZONE=${DJANGO_TIME_ZONE}
      - REDIS_HOST=${REDIS_HOST}
      - DJANGO_DEBUG=${DJANGO_DEBUG}
      - DJANGO_DEFAULT_FROM_EMAIL=${DJANGO_DEFAULT_FROM_EMAIL}
      - DJANGO_EMAIL_PORT=${DJANGO_EMAIL_PORT}
      - DJANGO_EMAIL_BACKEND=${DJANGO_EMAIL_BACKEND}
      - DJANGO_DASHBOARD_CORS_ORIGIN_ALLOW_ALL=${DJANGO_DASHBOARD_CORS_ORIGIN_ALLOW_ALL}
      - DJANGO_X509_DEFAULT_CERT_VALIDITY=${DJANGO_X509_DEFAULT_CERT_VALIDITY}
      - DJANGO_X509_DEFAULT_CA_VALIDITY=${DJANGO_X509_DEFAULT_CA_VALIDITY}
    depends_on:
      - postgres
      - redis
    volumes:
      - /opt/openwisp/static/dashboard:/opt/openwisp/static/

  controller:
    image:  atb00ker/ready-to-run:openwisp-controller
    build: 
      context: build
      dockerfile: openwisp_controller/Dockerfile
    environment: 
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      - DB_ENGINE=${DB_GIS_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DJANGO_LANGUAGE_CODE=${DJANGO_LANGUAGE_CODE}
      - DJANGO_TIME_ZONE=${DJANGO_TIME_ZONE}
      - REDIS_HOST=${REDIS_HOST}
      - DJANGO_DEBUG=${DJANGO_DEBUG}
      - DJANGO_X509_DEFAULT_CERT_VALIDITY=${DJANGO_X509_DEFAULT_CERT_VALIDITY}
      - DJANGO_X509_DEFAULT_CA_VALIDITY=${DJANGO_X509_DEFAULT_CA_VALIDITY}
      - DJANGO_DEFAULT_FROM_EMAIL=${DJANGO_DEFAULT_FROM_EMAIL}
      - DJANGO_EMAIL_PORT=${DJANGO_EMAIL_PORT}
      - DJANGO_EMAIL_BACKEND=${DJANGO_EMAIL_BACKEND}
      - OPENWISP_DASHBOARD_PROTOCOL=${OPENWISP_DASHBOARD_PROTOCOL}
      - OPENWISP_DASHBOARD_HOST=${OPENWISP_DASHBOARD_HOST}
      - OPENWISP_DASHBOARD_LISTEN_PORT=${OPENWISP_DASHBOARD_LISTEN_PORT}
    deploy:
      replicas: 1
    depends_on:
      - postgres
      - redis
    volumes:
      - openwisp_media:/opt/openwisp/media
      - /opt/openwisp/static/controller:/opt/openwisp/static/

  radius:
    image: atb00ker/ready-to-run:openwisp-radius
    build: 
      context: build
      dockerfile: openwisp_radius/Dockerfile
    deploy:
      replicas: 1
    depends_on:
      - postgres
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DJANGO_LANGUAGE_CODE=${DJANGO_LANGUAGE_CODE}
      - DJANGO_TIME_ZONE=${DJANGO_TIME_ZONE}
      - DJANGO_DEBUG=${DJANGO_DEBUG}
      - DJANGO_DEFAULT_FROM_EMAIL=${DJANGO_DEFAULT_FROM_EMAIL}
      - DJANGO_EMAIL_PORT=${DJANGO_EMAIL_PORT}
      - DJANGO_EMAIL_BACKEND=${DJANGO_EMAIL_BACKEND}
      - OPENWISP_DASHBOARD_PROTOCOL=${OPENWISP_DASHBOARD_PROTOCOL}
      - OPENWISP_DASHBOARD_HOST=${OPENWISP_DASHBOARD_HOST}
      - OPENWISP_DASHBOARD_LISTEN_PORT=${OPENWISP_DASHBOARD_LISTEN_PORT}
      - CONTAINER_PORT=${RADIUS_APP_PORT}
    volumes:
      - /opt/openwisp/static/radius:/opt/openwisp/static/

  topology:
    image: atb00ker/ready-to-run:openwisp-topology
    build: 
      context: build
      dockerfile: openwisp_topology/Dockerfile
    deploy:
      replicas: 1
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DJANGO_LANGUAGE_CODE=${DJANGO_LANGUAGE_CODE}
      - DJANGO_TIME_ZONE=${DJANGO_TIME_ZONE}
      - REDIS_HOST=${REDIS_HOST}
      - DJANGO_DEBUG=${DJANGO_DEBUG}
      - DJANGO_DEFAULT_FROM_EMAIL=${DJANGO_DEFAULT_FROM_EMAIL}
      - DJANGO_EMAIL_PORT=${DJANGO_EMAIL_PORT}
      - DJANGO_EMAIL_BACKEND=${DJANGO_EMAIL_BACKEND}
      - OPENWISP_DASHBOARD_PROTOCOL=${OPENWISP_DASHBOARD_PROTOCOL}
      - OPENWISP_DASHBOARD_HOST=${OPENWISP_DASHBOARD_HOST}
      - OPENWISP_DASHBOARD_LISTEN_PORT=${OPENWISP_DASHBOARD_LISTEN_PORT}
      - CONTAINER_PORT=${TOPOLOGY_APP_PORT}
    depends_on:
      - postgres
    volumes:
      - /opt/openwisp/static/topology:/opt/openwisp/static/

  nginx:
    image: atb00ker/ready-to-run:openwisp-nginx
    build: 
      context: build
      dockerfile: nginx/Dockerfile
    deploy:
      replicas: 1
    volumes:
      - /opt/openwisp/static/:/opt/openwisp/static/:ro
    environment:
      - DASHBOARD_APP_PORT=${DASHBOARD_APP_PORT}
      - CONTROLLER_APP_PORT=${CONTROLLER_APP_PORT}
      - RADIUS_APP_PORT=${RADIUS_APP_PORT}
      - TOPOLOGY_APP_PORT=${TOPOLOGY_APP_PORT}
      - OPENWISP_DASHBOARD_LISTEN_PORT=${OPENWISP_DASHBOARD_LISTEN_PORT}
      - OPENWISP_CONTROLLER_LISTEN_PORT=${OPENWISP_CONTROLLER_LISTEN_PORT}
      - OPENWISP_RADIUS_LISTEN_PORT=${OPENWISP_RADIUS_LISTEN_PORT}
      - OPENWISP_TOPOLOGY_LISTEN_PORT=${OPENWISP_TOPOLOGY_LISTEN_PORT}
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"
      - "8083:8083"
    depends_on:
      - dashboard
      - controller
      - radius
      - topology

  postgres:
    image: mdillon/postgis:10-alpine
    deploy:
      replicas: 1
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
    ports:
      - "5432:5432"

  redis:
    image: redis:alpine
    deploy:
      replicas: 1
    ports:
      - "6379:6379"

volumes:
  postgres_data: {}
  openwisp_media: {}
